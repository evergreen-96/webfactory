{% extends "base.html" %}

{% block content %}
    <h1>Фотосъемка с камеры</h1>

    <video id="webcam" autoplay></video>
    <button id="captureButton">Сделать фото</button>
    <canvas id="photoCanvas"></canvas>
    <a id="downloadLink" style="display: none;" download="photo.jpg">Скачать фото</a>

    <h1>Сканирование QR-кодов с камеры</h1>

    <video id="video" autoplay></video>
    <canvas id="canvas" style="display: none;"></canvas>
    <button id="scanButton">Сканировать</button>
    <p id="resultText"></p>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const scanButton = document.getElementById('scanButton');
        const resultText = document.getElementById('resultText');

        // Запрашиваем доступ к камере
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function (stream) {
                video.srcObject = stream;
            })
            .catch(function (error) {
                console.error('Ошибка при доступе к камере:', error);
            });

        scanButton.addEventListener('click', function () {
            // Создаем снимок текущего кадра с видеопотока
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Получаем изображение из canvas в формате base64
            const imageBase64 = canvas.toDataURL('image/png');

            // Отправляем изображение на сервер для сканирования
            fetch('endpoint/', {
                method: 'POST',
                body: JSON.stringify({ image: imageBase64 }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
            })
            .then(response => response.json())
            .then(data => {
                resultText.textContent = data.result;
            })
            .catch(error => {
                console.error('Ошибка при сканировании:', error);
            });
        });

        function getCookie(name) {
            var value = "; " + document.cookie;
            var parts = value.split("; " + name + "=");
            if (parts.length == 2) return parts.pop().split(";").shift();
        }
    </script>

    <form method="post">
        {% csrf_token %}
        <button type="submit" class="btn btn-success">Подтвердить</button>
    </form>


{% endblock %}
