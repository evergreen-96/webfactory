{% extends 'base.html' %}

{% block content %}

    {% for machine in machines %}
        <div class="form-check">
            <input class="form-check-input" type="radio" name="machine" value="{{ machine.id }}"
                   {% if machine.is_broken %}disabled{% endif %}
                   {% if machine.is_in_progress %}data-in-progress="true"{% endif %}
                   {% if not machine.is_broken %}data-not-broken="true"{% endif %}>
            <label class="form-check-label">
                {{ machine.id }}
                {{ machine.machine_name }}
                {{ machine.machine_type }}
                {% if machine.is_broken %}
                    <span class="text-danger">СЛОМАНО</span>
                {% endif %}
                {% if machine.is_in_progress %}
                    <span class="text-success">В РАБОТЕ</span>
                    {% with any_machine_in_progress=True %}
                    {% endwith %}
                {% endif %}
            </label>
        </div>
    {% endfor %}


    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="selected_machine_id" id="selectedMachineId" value="">
        <button type="submit" name="continue" id="continueButton" class="btn btn-primary" disabled>Continue working
        </button>
        <button type="submit" name="start_new" id="startNewButton" class="btn btn-success"
                {% if any_machine_in_progress or not any_machine_not_broken %}disabled{% endif %}>Start new
        </button>
        <button type="submit" name="stop_working" id="stopWorkingButton" class="btn btn-danger" disabled>Stop working
        </button>

        <button type="submit" name="end_shift" class="btn btn-secondary">End shift</button>
    </form>
    {% include "bugreport_form.html" %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var continueButton = document.getElementById("continueButton");
            var startNewButton = document.getElementById("startNewButton");
            var stopWorkingButton = document.getElementById("stopWorkingButton");
            var selectedMachineIdInput = document.getElementById("selectedMachineId");
            var radios = document.querySelectorAll('input[type=radio][name=machine]');

            radios.forEach(function (radio) {
                radio.addEventListener('change', function () {
                    continueButton.disabled = !(this.checked && this.getAttribute('data-in-progress') === 'true');
                    startNewButton.disabled = this.checked && (this.getAttribute('data-in-progress') === 'true' || this.getAttribute('data-broken') === 'true');
                    stopWorkingButton.disabled = !(this.checked && this.getAttribute('data-in-progress') === 'true');

                    // Дополнительная проверка для активации кнопки "start new"
                    if (this.checked && this.getAttribute('data-in-progress') !== 'true' && this.getAttribute('data-broken') !== 'true') {
                        startNewButton.disabled = false;
                    }

                    // Обновление значения скрытого поля с ID выбранной детали
                    selectedMachineIdInput.value = this.value;
                });
            });
        });
    </script>

{% endblock %}
